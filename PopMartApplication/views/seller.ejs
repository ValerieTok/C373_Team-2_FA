<%- include("partials/header", { title: "Seller Dashboard" }) %>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; flex-wrap:wrap; gap:10px;">
  <span class="role-tag">Seller dashboard</span>
  <div class="card" style="padding:10px 14px; border-radius:14px;">
    <span class="muted">Earnings released</span>
    <div class="mono" style="font-size:16px;"><%= earningsEth.toFixed(2) %> ETH</div>
  </div>
</div>

<section class="card fade-in" id="sellerVerificationCard">
  <h2 style="margin-top:0;">Seller verification</h2>
  <p class="muted">Verify your name, email, and phone with MetaMask before listing products.</p>
  <div id="sellerVerificationForm">
    <button class="btn btn-outline" type="button" id="selectSellerWalletBtn" style="margin-bottom:10px;">
      Select seller wallet
    </button>
    <form class="stack" id="sellerVerifyForm">
      <input type="text" name="sellerName" placeholder="Full name" required />
      <input type="email" name="sellerEmail" placeholder="Work email" required />
      <input type="tel" name="sellerPhone" placeholder="Phone number" required />
      <button class="btn btn-alt" type="submit">Verify with MetaMask</button>
      <p class="muted" id="sellerVerificationStatus"></p>
    </form>
    <div class="badge" id="sellerVerifiedBadge" style="display:none;">Seller verified</div>
  </div>
  <div class="stack" id="sellerVerifiedSummary" style="display:none;">
    <div class="badge">Seller verified</div>
    <p class="muted" id="sellerVerifiedSummaryText"></p>
  </div>
</section>

<div class="card" id="sellerLockedNotice" style="display:none; margin-bottom:14px;">
  <p class="muted" style="margin:0;">Complete seller verification to see your listings and orders.</p>
</div>

<div class="grid" data-requires-seller-verified>
  <section class="card fade-in">
    <h2 style="margin-top:0;">List a Product</h2>
    <p class="muted">Add a new listing that appears on the marketplace.</p>
    <form action="/seller/listings" method="POST" class="stack" enctype="multipart/form-data">
      <% const template = listingTemplate || {}; %>
      <input type="text" name="name" placeholder="Product name" value="<%= template.name || '' %>" required />
      <input type="text" name="category" placeholder="Category" value="<%= template.category || '' %>" required />
      <input type="number" name="priceEth" step="0.01" min="0" placeholder="Price in ETH" value="<%= template.priceEth != null ? template.priceEth : '' %>" required />
      <input type="file" name="imageFile" accept="image/*" />
      <input type="hidden" name="image" value="<%= template.image || '' %>" />
      <input type="text" name="shortDesc" placeholder="Short description" value="<%= template.shortDesc || '' %>" required />
      <input type="hidden" name="sellerWallet" id="sellerWalletField" value="<%= defaultSellerWallet %>" />
      <button class="btn btn-alt" type="submit">Publish Listing</button>
    </form>
  </section>

  <section class="card fade-in">
    <h2 style="margin-top:0;">Your Listings</h2>
    <p class="muted">Check how your products appear on the marketplace.</p>
    <div class="list">
      <% products.forEach(function(product) { %>
        <div class="list-item">
          <img class="thumb" src="<%= product.image %>" alt="Product image" />
          <div class="stack">
            <strong><%= product.name %></strong>
          <span class="mono"><%= product.priceEth %> ETH</span>
          </div>
        </div>
      <% }) %>
    </div>
  </section>
</div>

<section class="card fade-in" style="margin-top:18px;" data-requires-seller-verified>
  <h2 style="margin-top:0;">Orders to Fulfill</h2>
  <p class="muted">View incoming orders and confirm shipment when you ship.</p>
  <p class="muted" style="margin-bottom:12px;">Latest orders are shown below.</p>
  <div class="list">
    <% if (!orders.length) { %>
      <p class="muted">No orders yet.</p>
    <% } %>
    <% orders.forEach(function(order) { %>
      <div class="card" style="margin-bottom:12px; border-color:<%= order.paymentReleased ? '#16a34a' : '#e5e7eb' %>;">
        <% if (order.paymentReleased) { %>
          <div class="badge" style="float:right; background:#dcfce7; color:#166534;">Completed</div>
        <% } %>
        <div class="list-item">
          <img class="thumb" src="<%= order.image || '/images/popmart1.png' %>" alt="Product image" />
          <div class="stack">
            <strong>Order <%= order.id %></strong>
            <span class="muted"><%= order.productName %> x <%= order.qty %></span>
            <span class="muted">Buyer: <%= order.buyerName %></span>
            <span class="muted">Buyer phone: <%= order.buyerPhone || 'Not provided' %></span>
            <span class="muted">Ship to: <%= order.buyerAddress %></span>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill"><%= order.category %></span>
              <span class="badge">Status: <%= order.status %></span>
              <span class="mono"><%= order.priceEth %> ETH</span>
              <span class="pill">Escrow ID: <%= order.escrowOrderId || "Pending" %></span>
            </div>
            <div class="timeline">
              <div class="timeline-item">
                Order placed: <span class="mono"><%= order.createdAtDisplay %></span>
              </div>
              <div class="timeline-item">
                Shipment confirmed: <span class="mono"><%= order.shippedAtDisplay %></span>
              </div>
              <div class="timeline-item">
                Delivery confirmed: <span class="mono"><%= order.deliveredAtDisplay %></span>
              </div>
              <div class="timeline-item">
                Payment released: <span class="mono"><%= order.releasedAtDisplay %></span>
              </div>
            </div>
            <form action="/seller/orders/<%= order.id %>/ship" method="POST" data-escrow-action="ship" data-escrow-order-id="<%= order.escrowOrderId || '' %>" data-expected-wallet="<%= order.sellerWallet || '' %>">
              <button
                class="btn btn-alt"
                type="submit"
                <%= order.status !== "Awaiting Shipment" ? "disabled" : "" %>
                style="<%= order.status !== 'Awaiting Shipment' ? 'background:#e2e8f0; border-color:#e2e8f0; color:#475569;' : '' %><%= order.status === 'Shipped' ? 'background:#16a34a; border-color:#16a34a; color:#f8fafc;' : '' %>"
              >
                <%= order.status === "Awaiting Shipment" ? "Confirm shipment" : "Shipment confirmed" %>
              </button>
            </form>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</section>

<%- include("partials/footer") %>
