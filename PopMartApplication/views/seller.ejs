<%- include("partials/header", { title: "Seller Dashboard" }) %>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; flex-wrap:wrap; gap:10px;">
  <span class="role-tag">Seller dashboard</span>
  <div class="card" style="padding:10px 14px; border-radius:14px;">
    <span class="muted">Earnings released</span>
    <div class="mono" style="font-size:16px;"><%= earningsEth.toFixed(2) %> ETH</div>
  </div>
</div>

<section class="card fade-in" id="sellerVerificationCard">
  <% if (!sellerAccess) { %>
    <h2 style="margin-top:0;">Seller access locked</h2>
    <p class="muted">Connect the wallet that published the listing to access seller tools.</p>
    <button class="btn btn-outline" type="button" id="selectSellerWalletBtn">Select seller wallet</button>
  <% } else { %>
    <h2 style="margin-top:0;">Seller verification</h2>
    <p class="muted">Verify your name, email, and phone with MetaMask before listing products.</p>
    <div id="sellerVerificationForm">
      <button class="btn btn-outline" type="button" id="selectSellerWalletBtn" style="margin-bottom:10px;">
        Select seller wallet
      </button>
      <form class="stack" id="sellerVerifyForm">
        <input type="text" name="sellerName" placeholder="Full name" required />
        <input type="email" name="sellerEmail" placeholder="Work email" required />
        <input type="tel" name="sellerPhone" placeholder="Phone number" required />
        <button class="btn btn-alt" type="submit">Verify with MetaMask</button>
        <p class="muted" id="sellerVerificationStatus"></p>
      </form>
      <div class="badge" id="sellerVerifiedBadge" style="display:none;">Seller verified</div>
    </div>
    <div class="stack" id="sellerVerifiedSummary" style="display:none;">
      <div class="badge">Seller verified</div>
      <p class="muted" id="sellerVerifiedSummaryText"></p>
    </div>
  <% } %>
</section>

<div class="card" id="sellerLockedNotice" style="display:none; margin-bottom:14px;">
  <p class="muted" style="margin:0;">Complete seller verification to see your listings and orders.</p>
</div>

<% if (sellerAccess) { %>
<div class="grid" data-requires-seller-verified>
  <section class="card fade-in">
    <h2 style="margin-top:0;">List a Product</h2>
    <p class="muted">Add a new listing that appears on the marketplace.</p>
    <form action="/seller/listings" method="POST" class="stack" enctype="multipart/form-data" data-listing-create>
      <% const template = listingTemplate || {}; %>
      <input type="text" name="name" placeholder="Product name" value="<%= template.name || '' %>" required />
      <input type="text" name="category" placeholder="Category" value="<%= template.category || '' %>" required />
      <input type="number" name="priceEth" step="0.01" min="0" placeholder="Price in ETH" value="<%= template.priceEth != null ? template.priceEth : '' %>" required />
      <input type="file" name="imageFile" accept="image/*" />
      <input type="hidden" name="image" value="<%= template.image || '' %>" />
      <input type="text" name="shortDesc" placeholder="Short description" value="<%= template.shortDesc || '' %>" required />
      <input type="hidden" name="sellerWallet" id="sellerWalletField" value="<%= defaultSellerWallet %>" />
      <button class="btn btn-alt" type="submit">Publish Listing</button>
      <span class="muted status-text" data-tx-status></span>
    </form>
  </section>

  <section class="card fade-in">
    <h2 style="margin-top:0;">Your Listings</h2>
    <p class="muted">Check how your products appear on the marketplace.</p>
    <div class="list">
      <% products.forEach(function(product) { %>
        <div class="list-item">
          <img class="thumb" src="<%= product.image %>" alt="Product image" />
          <div class="stack">
            <strong><%= product.name %></strong>
          <span class="mono"><%= product.priceEth %> ETH</span>
          </div>
        </div>
      <% }) %>
    </div>
  </section>
</div>

<section class="card fade-in" style="margin-top:18px;" data-requires-seller-verified>
  <h2 style="margin-top:0;">Orders to Fulfill</h2>
  <p class="muted">View incoming orders and confirm shipment when you ship.</p>
  <p class="muted" style="margin-bottom:12px;">Latest orders are shown below.</p>
  <div class="list">
    <% if (!orders.length) { %>
      <p class="muted">No orders yet.</p>
    <% } %>
    <% orders.forEach(function(order) { %>
      <div class="card" style="margin-bottom:12px; border-color:<%= order.paymentReleased ? '#16a34a' : '#e5e7eb' %>;">
        <% if (order.paymentReleased) { %>
          <div class="badge" style="float:right; background:#dcfce7; color:#166534;">Completed</div>
        <% } %>
        <div class="list-item">
          <img class="thumb" src="<%= order.image || '/images/popmart1.png' %>" alt="Product image" />
          <div class="stack">
            <strong>Order <%= order.id %></strong>
            <span class="muted"><%= order.productName %> x <%= order.qty %></span>
            <span class="muted">Buyer: <%= order.buyerName %></span>
            <span class="muted">Buyer phone: <%= order.buyerPhone || 'Not provided' %></span>
            <span class="muted">Ship to: <%= order.buyerAddress %></span>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill"><%= order.category %></span>
              <span class="badge">Status: <%= order.status %></span>
              <span class="mono"><%= order.priceEth %> ETH</span>
              <span class="pill">Escrow ID: <%= order.escrowOrderId || "Pending" %></span>
            </div>
            <div class="timeline">
              <div class="timeline-item">
                Order placed: <span class="mono"><%= order.createdAtDisplay %></span>
              </div>
              <div class="timeline-item">
                Shipment confirmed: <span class="mono"><%= order.shippedAtDisplay %></span>
              </div>
              <div class="timeline-item">
                Delivery confirmed: <span class="mono"><%= order.deliveredAtDisplay %></span>
              </div>
              <div class="timeline-item">
                Payment released: <span class="mono"><%= order.releasedAtDisplay %></span>
              </div>
            </div>
            <% if (order.status === "Awaiting Shipment" || order.status === "Shipped" || order.status === "Delivered") { %>
              <div style="margin-top:10px; padding:10px 12px; border:1px dashed #e2e8f0; border-radius:12px;">
                <strong>Print receipt → verify receipt → upload shipment proof</strong>
                <p class="muted" style="margin:6px 0 0;">
                  Complete these steps before confirming shipment.
                </p>
                <div style="margin-top:8px;">
                  <div class="muted">Order hash: <span class="mono"><%= order.orderHash || "Pending" %></span></div>
                  <% if (order.notarizeTxHash) { %>
                    <div class="muted">Notarize tx: <span class="mono"><%= order.notarizeTxHash %></span></div>
                  <% } %>
                  <button
                    class="btn btn-ghost"
                    type="button"
                    data-receipt-print
                    data-receipt-type="shipment"
                    data-order-id="<%= order.escrowOrderId || '' %>"
                    <%= order.escrowOrderId ? "" : "disabled" %>
                    data-seller-wallet="<%= order.sellerWallet || '' %>"
                    data-buyer-wallet="<%= order.buyerWallet || '' %>"
                    data-product-name="<%= order.productName || '' %>"
                    data-qty="<%= order.qty %>"
                    data-price-eth="<%= order.priceEth %>"
                    data-shipped-at="<%= order.shippedAtDisplay %>"
                  >
                    Print receipt
                  </button>
                  <button
                    class="btn btn-outline"
                    type="button"
                    data-receipt-verify
                    data-order-id="<%= order.escrowOrderId || '' %>"
                    data-receipt-type="shipment"
                    data-can-notarize="true"
                    data-seller-wallet="<%= order.sellerWallet || '' %>"
                    data-buyer-wallet="<%= order.buyerWallet || '' %>"
                    data-product-name="<%= order.productName || '' %>"
                    data-qty="<%= order.qty %>"
                    data-price-eth="<%= order.priceEth %>"
                    data-shipped-at="<%= order.shippedAtDisplay %>"
                    <%= order.orderHash && order.escrowOrderId ? "" : "disabled" %>
                  >
                    Verify receipt
                  </button>
                  <span class="muted status-text" data-verify-status style="margin-left:6px;"></span>
                  <span class="muted status-text" data-verify-timestamp style="margin-left:6px;"></span>
                </div>
                <% if (order.shipmentProofFile) { %>
                  <a class="btn btn-ghost" style="margin-top:8px;" href="<%= order.shipmentProofFile %>" target="_blank" rel="noopener">
                    View receipt
                  </a>
                <% } else { %>
                  <form
                    class="stack"
                    action="/seller/orders/<%= order.id %>/proof-shipped"
                    method="POST"
                    enctype="multipart/form-data"
                    data-proof-upload
                  >
                    <input type="file" name="proofFile" accept="image/*,application/pdf" required data-proof-input />
                    <div class="muted" style="font-size:12px;">PNG/JPG/PDF up to 8MB.</div>
                    <div class="proof-preview">
                      <img
                        class="thumb"
                        data-proof-preview
                        alt="Shipment proof preview"
                        style="width:56px; height:56px; border-radius:10px; border:1px solid #e2e8f0; object-fit:cover; display:none;"
                      />
                      <span class="muted" data-proof-meta></span>
                    </div>
                    <button class="btn btn-ghost" type="submit" disabled>Upload shipment proof</button>
                    <span class="muted status-text" data-tx-status>Verify the receipt to enable upload.</span>
                  </form>
                <% } %>
              </div>
            <% } %>
            <% if (order.status === "Awaiting Shipment" || order.status === "Shipped" || order.status === "Delivered") { %>
              <% const canConfirmShipment = order.status === "Awaiting Shipment" && order.shipmentProofFile; %>
              <form action="/seller/orders/<%= order.id %>/ship" method="POST" data-escrow-action="ship" data-escrow-order-id="<%= order.escrowOrderId || '' %>" data-expected-wallet="<%= order.sellerWallet || '' %>" data-proof-uploaded="<%= order.shipmentProofFile ? 'true' : '' %>">
                <button
                  class="btn btn-alt"
                  type="submit"
                  <%= !canConfirmShipment ? "disabled" : "" %>
                  style="<%= !canConfirmShipment ? 'background:#e2e8f0; border-color:#e2e8f0; color:#475569;' : '' %><%= order.status === 'Shipped' ? 'background:#16a34a; border-color:#16a34a; color:#f8fafc;' : '' %>"
                >
                  <%= order.status === "Awaiting Shipment" ? "Confirm shipment" : "Shipment confirmed" %>
                </button>
                <span class="muted status-text" data-tx-status style="margin-left:8px;"></span>
                <% if (!canConfirmShipment && order.status === "Awaiting Shipment") { %>
                  <div class="muted" style="margin-top:6px;">Verify the receipt and upload shipment proof to enable confirmation.</div>
                <% } %>
              </form>
            <% } %>
            <% if (order.status === "Delivered") { %>
              <div style="margin-top:10px; padding:10px 12px; border:1px dashed #e2e8f0; border-radius:12px;">
                <strong>Delivery receipt</strong>
                <p class="muted" style="margin:6px 0 0;">
                  Generate and print a notarized receipt after delivery is completed.
                </p>
                <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                  <button
                    class="btn btn-outline"
                    type="button"
                    data-receipt-verify
                    data-receipt-type="delivery"
                    data-order-id="<%= order.escrowOrderId || '' %>"
                    data-can-notarize="true"
                    data-seller-wallet="<%= order.sellerWallet || '' %>"
                    data-buyer-wallet="<%= order.buyerWallet || '' %>"
                    data-product-name="<%= order.productName || '' %>"
                    data-qty="<%= order.qty %>"
                    data-price-eth="<%= order.priceEth %>"
                    data-delivered-at="<%= order.deliveredAtDisplay %>"
                    <%= order.escrowOrderId ? "" : "disabled" %>
                  >
                    Verify delivery receipt
                  </button>
                  <button
                    class="btn btn-ghost"
                    type="button"
                    data-receipt-print
                    data-receipt-type="delivery"
                    data-order-id="<%= order.escrowOrderId || '' %>"
                    <%= order.escrowOrderId ? "" : "disabled" %>
                    data-seller-wallet="<%= order.sellerWallet || '' %>"
                    data-buyer-wallet="<%= order.buyerWallet || '' %>"
                    data-product-name="<%= order.productName || '' %>"
                    data-qty="<%= order.qty %>"
                    data-price-eth="<%= order.priceEth %>"
                    data-delivered-at="<%= order.deliveredAtDisplay %>"
                  >
                    Print receipt
                  </button>
                  <span class="muted status-text" data-verify-status style="margin-left:6px;"></span>
                  <span class="muted status-text" data-verify-timestamp style="margin-left:6px;"></span>
                </div>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</section>
<% } %>

<%- include("partials/footer") %>
