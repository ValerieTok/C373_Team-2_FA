<%- include("partials/header", { title: "Marketplace Listings" }) %>

<section class="page-card">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
    <span class="role-tag">Buyer view</span>
  </div>
  <div class="listing-head" style="margin-bottom:16px;">
    <h1 class="listing-title">Listings</h1>
    <span class="muted" style="text-transform:uppercase; letter-spacing:1px; font-size:12px;">
      <%= products.length %> items
    </span>
  </div>
  <hr style="border:none; border-top:1px solid #e5e7eb; margin:0 0 18px;" />

  <div class="list">
    <% products.forEach(function(product) { %>
      <article class="listing-row">
        <div class="listing-image">
          <img src="<%= product.image %>" alt="Product image" />
        </div>
        <div>
          <div class="listing-head">
            <h2 class="listing-title"><%= product.name %></h2>
            <span class="mono"><%= product.priceEth %> ETH</span>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;">
            <span class="pill"><%= product.category %></span>
            <% const ratingInfo = ratingsSummary[product.id] || { avg: 0, count: 0 }; %>
            <span class="pill">
              Avg rating: <%= ratingInfo.count ? ratingInfo.avg.toFixed(2) : "No ratings" %>
              <% if (ratingInfo.count) { %> / 5 (<%= ratingInfo.count %>)<% } %>
            </span>
            <% const shipInfo = shipTimeSummary[product.id] || { avgDisplay: "Pending", count: 0 }; %>
            <span class="pill" title="Simulated: 1 second = 10 minutes.">
              Avg ship time: <%= shipInfo.count ? shipInfo.avgDisplay : "Pending" %>
            </span>
            <% if (bestProductId === product.id) { %>
              <span class="pill">Top rated</span>
            <% } %>
          </div>
          <p class="listing-desc muted"><%= product.shortDesc %></p>
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <a class="btn btn-outline" href="/product/<%= product.id %>">View details</a>
            <div style="display:flex; gap:6px; align-items:center;">
              <form action="/listings/<%= product.id %>/qty/decrease" method="POST">
                <button class="btn btn-outline" type="submit">-</button>
              </form>
              <input type="number" name="qty" min="1" value="<%= quantities[product.id] %>" style="width:70px;" readonly />
              <form action="/listings/<%= product.id %>/qty/increase" method="POST">
                <button class="btn btn-outline" type="submit">+</button>
              </form>
            </div>
            <form action="/cart/add" method="POST" style="display:flex; gap:8px; align-items:center;">
              <input type="hidden" name="productId" value="<%= product.id %>" />
              <input type="hidden" name="name" value="<%= product.name %>" />
              <input type="hidden" name="category" value="<%= product.category %>" />
              <input type="hidden" name="priceEth" value="<%= product.priceEth %>" />
              <input type="hidden" name="image" value="<%= product.image %>" />
              <input type="hidden" name="sellerWallet" value="<%= product.sellerWallet || '' %>" />
              <input type="hidden" name="qty" value="<%= quantities[product.id] %>" />
              <button class="btn" type="submit">Add to cart</button>
            </form>
          </div>
        </div>
      </article>
    <% }) %>
  </div>
</section>

<%- include("partials/footer") %>
