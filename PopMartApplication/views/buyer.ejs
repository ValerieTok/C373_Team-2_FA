<%- include("partials/header", { title: "Buyer Dashboard" }) %>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
  <span class="role-tag">Buyer dashboard</span>
</div>

<section class="card fade-in">
  <h2 style="margin-top:0;">Buyer Actions</h2>
  <p class="muted">Add items from listings to your cart, checkout, confirm delivery, and rate sellers.</p>
  <div style="display:flex; gap:12px; flex-wrap:wrap;">
    <a class="btn btn-alt" href="/cart">Go to cart</a>
    <a class="btn btn-ghost" href="/">Browse listings</a>
  </div>
</section>

<section class="card fade-in" style="margin-top:18px;">
  <h2 style="margin-top:0;">Your Orders</h2>
  <p class="muted">Confirm delivery and submit ratings after items arrive.</p>
  <div class="list">
    <% if (!orders.length) { %>
      <p class="muted">No orders yet.</p>
    <% } %>
    <% orders.forEach(function(order) { %>
      <div class="card" style="margin-bottom:12px;">
        <div class="list-item">
          <img class="thumb" src="<%= order.image || '/images/popmart1.png' %>" alt="Product image" />
          <div class="stack">
            <strong>Order <%= order.id %></strong>
            <span class="muted"><%= order.productName %> x <%= order.qty %></span>
            <span class="muted">Ship to: <%= order.buyerAddress %></span>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill"><%= order.category %></span>
              <span class="badge">Status: <%= order.status %></span>
              <span class="mono"><%= order.priceEth %> ETH</span>
              <span class="pill">Escrow ID: <%= order.escrowOrderId || "Pending" %></span>
            </div>
            <form action="/buyer/orders/<%= order.id %>/deliver" method="POST" data-escrow-action="deliver" data-escrow-order-id="<%= order.escrowOrderId || '' %>" data-expected-wallet="<%= order.buyerWallet || '' %>">
              <button class="btn btn-alt" type="submit" <%= order.status !== "Shipped" ? "disabled" : "" %>>
                Confirm delivery
              </button>
            </form>
            <% if (order.status === "Delivered" && !order.rated && !order.reviewSkipped) { %>
              <% if (!order.reviewOpen) { %>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <form action="/buyer/orders/<%= order.id %>/review/start" method="POST">
                    <button class="btn btn-ghost" type="submit">Leave a review</button>
                  </form>
                  <form action="/buyer/orders/<%= order.id %>/review/skip" method="POST">
                    <button class="btn btn-outline" type="submit">Skip review</button>
                  </form>
                </div>
              <% } else { %>
                <form class="stack" action="/buyer/orders/<%= order.id %>/rate" method="POST" data-escrow-action="rate" data-escrow-order-id="<%= order.escrowOrderId || '' %>" data-expected-wallet="<%= order.buyerWallet || '' %>">
                  <label>Stars (1-5)</label>
                  <select name="stars" required>
                    <option value="1">1 star</option>
                    <option value="2">2 stars</option>
                    <option value="3">3 stars</option>
                    <option value="4">4 stars</option>
                    <option value="5" selected>5 stars</option>
                  </select>
                  <label>Comment</label>
                  <textarea name="comment" rows="3" required></textarea>
                  <button class="btn btn-ghost" type="submit">Submit rating</button>
                </form>
              <% } %>
            <% } else if (order.rated) { %>
              <span class="muted">Rating submitted.</span>
            <% } else if (order.reviewSkipped) { %>
              <span class="muted">Review skipped.</span>
            <% } %>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</section>

<%- include("partials/footer") %>
