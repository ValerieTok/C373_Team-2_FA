<%- include("partials/header", { title: "Buyer Dashboard" }) %>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
  <span class="role-tag">Buyer dashboard</span>
</div>

<section class="card fade-in">
  <h2 style="margin-top:0;">Buyer Actions</h2>
  <p class="muted">Add items from listings to your cart, checkout, confirm delivery, and rate sellers.</p>
  <div style="display:flex; gap:12px; flex-wrap:wrap;">
    <a class="btn btn-alt" href="/cart">Go to cart</a>
    <a class="btn btn-ghost" href="/">Browse listings</a>
  </div>
</section>

<section class="card fade-in" style="margin-top:18px;">
  <h2 style="margin-top:0;">Your Orders</h2>
  <p class="muted">Confirm delivery and submit ratings after items arrive.</p>
  <div class="list">
    <% if (!orders.length) { %>
      <p class="muted">No orders yet.</p>
    <% } %>
    <% orders.forEach(function(order) { %>
      <div class="card" style="margin-bottom:12px; border-color:<%= order.paymentReleased ? '#16a34a' : '#e5e7eb' %>;">
        <% if (order.paymentReleased) { %>
          <div class="badge" style="float:right; background:#dcfce7; color:#166534;">Completed</div>
        <% } %>
        <div class="list-item">
          <img class="thumb" src="<%= order.image || '/images/popmart1.png' %>" alt="Product image" />
          <div class="stack">
            <strong>Order <%= order.id %></strong>
            <span class="muted"><%= order.productName %> x <%= order.qty %></span>
            <span class="muted">Ship to: <%= order.buyerAddress %></span>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill"><%= order.category %></span>
              <span class="badge">Status: <%= order.status %></span>
              <span class="mono"><%= order.priceEth %> ETH</span>
              <span class="pill">Escrow ID: <%= order.escrowOrderId || "Pending" %></span>
            </div>
            <% if (order.status === "Shipped" || order.status === "Delivered") { %>
              <form action="/buyer/orders/<%= order.id %>/deliver" method="POST" data-escrow-action="deliver" data-escrow-order-id="<%= order.escrowOrderId || '' %>" data-expected-wallet="<%= order.buyerWallet || '' %>">
                <button
                  class="btn btn-alt"
                  type="submit"
                  <%= order.status !== "Shipped" ? "disabled" : "" %>
                  style="<%= order.status !== 'Shipped' ? 'background:#e2e8f0; border-color:#e2e8f0; color:#475569;' : '' %><%= order.status === 'Delivered' ? 'background:#16a34a; border-color:#16a34a; color:#f8fafc;' : '' %>"
                >
                  <%= order.status === "Delivered" ? "Delivery confirmed" : "Confirm delivery" %>
                </button>
              </form>
            <% } %>
            <% if (order.status === "Delivered" && !order.rated && !order.reviewSkipped) { %>
              <% if (!order.reviewOpen) { %>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <form action="/buyer/orders/<%= order.id %>/review/start" method="POST">
                    <button class="btn btn-ghost" type="submit">Leave a review</button>
                  </form>
                  <form action="/buyer/orders/<%= order.id %>/review/skip" method="POST">
                    <button class="btn btn-outline" type="submit">Skip review</button>
                  </form>
                </div>
              <% } else { %>
                <form class="stack" action="/buyer/orders/<%= order.id %>/rate" method="POST" data-escrow-action="rate" data-escrow-order-id="<%= order.escrowOrderId || '' %>" data-expected-wallet="<%= order.buyerWallet || '' %>">
                  <label>Stars (1-5)</label>
                  <div class="star-rating">
                    <input type="radio" id="order-<%= order.id %>-star-5" name="stars" value="5" checked required />
                    <label for="order-<%= order.id %>-star-5" title="5 stars">★</label>
                    <input type="radio" id="order-<%= order.id %>-star-4" name="stars" value="4" />
                    <label for="order-<%= order.id %>-star-4" title="4 stars">★</label>
                    <input type="radio" id="order-<%= order.id %>-star-3" name="stars" value="3" />
                    <label for="order-<%= order.id %>-star-3" title="3 stars">★</label>
                    <input type="radio" id="order-<%= order.id %>-star-2" name="stars" value="2" />
                    <label for="order-<%= order.id %>-star-2" title="2 stars">★</label>
                    <input type="radio" id="order-<%= order.id %>-star-1" name="stars" value="1" />
                    <label for="order-<%= order.id %>-star-1" title="1 star">★</label>
                  </div>
                  <label>Comment</label>
                  <textarea name="comment" rows="3" required></textarea>
                  <button class="btn btn-ghost" type="submit">Submit rating</button>
                </form>
              <% } %>
            <% } else if (order.rated) { %>
              <span class="muted">Rating submitted.</span>
            <% } else if (order.reviewSkipped) { %>
              <span class="muted">Review skipped.</span>
            <% } %>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</section>

<%- include("partials/footer") %>
