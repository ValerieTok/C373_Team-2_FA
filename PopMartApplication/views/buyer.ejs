<%- include("partials/header", { title: "Buyer Dashboard" }) %>

<div
  class="card"
  id="buyerPage"
  data-product-id="<%= product.id %>"
  data-product-name="<%= product.name %>"
  data-product-category="<%= product.category %>"
  data-product-seller="<%= product.sellerName %>"
  data-product-desc="<%= product.fullDesc %>"
  data-product-image="<%= product.image %>"
  data-product-price="<%= product.priceEth %>"
>
  <h2>Buyer Dashboard</h2>
  <p class="muted">
    Create orders, confirm delivery, and submit a verified rating once escrow is released.
  </p>

  <div class="row" style="align-items:flex-start;">
    <div style="flex:1; min-width:260px;">
      <img id="buyerProductImage" class="img" style="height:220px;" src="<%= product.image %>" alt="Product image"/>
    </div>

    <div style="flex:2; min-width:280px;">
      <h3 id="buyerProductName" style="margin-top:0;"><%= product.name %></h3>
      <div class="row">
        <span class="pill" id="buyerProductCategory"><%= product.category %></span>
        <span class="pill" id="buyerProductSellerName">Seller: <%= product.sellerName %></span>
      </div>
      <p class="muted" id="buyerProductDesc" style="margin:10px 0;"><%= product.fullDesc %></p>
      <p><b>Price:</b> <span class="mono" id="buyerProductPrice"><%= product.priceEth %></span> ETH</p>

      <hr style="border:none; border-top:1px solid #e5e7eb; margin:14px 0;"/>

      <h3>Order Actions</h3>
      <p class="muted">Use MetaMask to create an escrow order and confirm delivery.</p>

      <div class="row" style="margin-top:8px;">
        <label>Seller Wallet:</label>
        <input id="buyerSellerAddress" type="text" placeholder="0x..." style="padding:8px; border-radius:10px; border:1px solid #e5e7eb; width:340px;">
      </div>
      <div class="row" style="margin-top:8px;">
        <label>Amount (ETH):</label>
        <input id="buyerAmountEth" type="number" min="0" step="0.0001" style="padding:8px; border-radius:10px; border:1px solid #e5e7eb; width:140px;">
      </div>

      <button class="btn" id="buyerBuy">Buy with MetaMask</button>
      <p class="muted" id="buyerBuyStatus" style="margin-top:10px;"></p>

      <div class="row" style="margin-top:10px;">
        <label>Order ID:</label>
        <input id="buyerOrderIdInput" type="number" min="0" style="padding:8px; border-radius:10px; border:1px solid #e5e7eb; width:120px;">
        <button class="btn btn2" id="buyerLoadOrder">Load Order</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn" id="buyerDeliver" disabled>Confirm Delivery</button>
      </div>
      <p class="muted" id="buyerDeliverStatus" style="margin-top:10px;"></p>
      <p class="muted" id="buyerOrderStatus" style="margin-top:6px;"></p>

      <hr style="border:none; border-top:1px solid #e5e7eb; margin:14px 0;"/>

      <h3>Rate Seller (After Payment Release)</h3>
      <p class="muted">
        Rating is only allowed after escrow payment has been released.
      </p>

      <div class="row">
        <label>Stars (1-5):</label>
        <input id="buyerStars" type="number" min="1" max="5" value="5" style="padding:8px; border-radius:10px; border:1px solid #e5e7eb; width:90px;">
      </div>

      <div style="margin-top:10px;">
        <label>Comment:</label><br/>
        <textarea id="buyerComment" rows="3" style="width:100%; padding:10px; border-radius:10px; border:1px solid #e5e7eb;"></textarea>
      </div>

      <button class="btn btn2" style="margin-top:10px;" id="buyerRate" disabled>
        Submit Rating
      </button>

      <p class="muted" id="buyerRateStatus" style="margin-top:10px;"></p>
    </div>
  </div>
</div>

<br/>

<div class="card">
  <h3>Order Status</h3>
  <p><b>Order ID:</b> <span class="mono" id="buyerOrderId">Not loaded</span></p>
  <p><b>Buyer:</b> <span class="mono" id="buyerOrderBuyer">-</span></p>
  <p><b>Seller:</b> <span class="mono" id="buyerOrderSeller">-</span></p>
  <p><b>Amount (wei):</b> <span class="mono" id="buyerOrderAmount">-</span></p>
  <p><b>Status:</b> <span class="mono" id="buyerOrderFlags">-</span></p>
</div>

<br/>

<div class="card">
  <h3>Seller Rating Snapshot</h3>
  <p class="muted">
    Average rating shown as "x.xx / 5".
  </p>
  <p><b>Average:</b> <span class="mono" id="buyerAvgRating">Loading...</span></p>
  <p><b>Total Ratings:</b> <span class="mono" id="buyerRatingCount">Loading...</span></p>
</div>

<%- include("partials/footer", { script: [
  "https://cdn.jsdelivr.net/npm/web3@4.16.0/dist/web3.min.js",
  "/js/rolePages.js"
] }) %>
