<%- include("partials/header", { title: "Buyer Dashboard" }) %>

<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
  <span class="role-tag" id="buyerDashboardTag">Buyer dashboard</span>
</div>

<section class="card fade-in">
  <h2 style="margin-top:0;">Buyer Actions</h2>
  <p class="muted">Add items from listings to your cart, checkout, confirm delivery, and rate sellers.</p>
  <div style="display:flex; gap:12px; flex-wrap:wrap;">
    <a class="btn btn-alt" href="/cart">Go to cart</a>
    <a class="btn btn-ghost" href="/">Browse listings</a>
  </div>
</section>

<section class="card fade-in" style="margin-top:18px;">
  <h2 style="margin-top:0;">Your Orders</h2>
  <p class="muted">Confirm delivery and submit ratings after items arrive.</p>
  <div class="list">
    <% if (!orders.length) { %>
      <p class="muted">No orders yet.</p>
    <% } %>
    <% orders.forEach(function(order) { %>
      <div class="card" style="margin-bottom:12px; border-color:<%= order.paymentReleased ? '#16a34a' : '#e5e7eb' %>;">
        <% if (order.paymentReleased) { %>
          <div class="badge" style="float:right; background:#dcfce7; color:#166534;">Completed</div>
        <% } %>
        <div class="list-item">
          <img class="thumb" src="<%= order.image || '/images/popmart1.png' %>" alt="Product image" />
          <div class="stack">
            <strong>Order <%= order.id %></strong>
            <span class="muted"><%= order.productName %> x <%= order.qty %></span>
            <span class="muted">Ship to: <%= order.buyerAddress %></span>
            <div style="display:flex; gap:8px; flex-wrap:wrap;">
              <span class="pill"><%= order.category %></span>
              <span class="badge">Status: <%= order.status %></span>
              <span class="mono"><%= order.priceEth %> ETH</span>
              <span class="pill">Escrow ID: <%= order.escrowOrderId || "Pending" %></span>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:6px;">
              <a class="btn btn-ghost" href="/qr/<%= order.id %>">Track via QR</a>
            </div>
            <% if (order.status === "Shipped" || order.status === "Delivered") { %>
              <div style="margin-top:10px; padding:10px 12px; border:1px dashed #e2e8f0; border-radius:12px;">
                <strong>View receipt</strong>
                <p class="muted" style="margin:6px 0 0;">
                  Review the seller's uploaded receipt before verifying.
                </p>
                <% if (order.shipmentProofFile) { %>
                  <a class="btn btn-ghost" style="margin-top:8px;" href="<%= order.shipmentProofFile %>" target="_blank" rel="noopener">
                    View receipt
                  </a>
                <% } else { %>
                  <div class="muted" style="margin-top:8px;">Seller has not uploaded a receipt yet.</div>
                <% } %>
                <div style="margin-top:10px;">
                  <strong>Verify receipt</strong>
                  <p class="muted" style="margin:6px 0 0;">
                    Verify the on-chain receipt before confirming delivery.
                  </p>
                </div>
                <div style="margin-top:8px;">
                  <div class="muted">Order hash: <span class="mono"><%= order.orderHash || "Pending" %></span></div>
                  <% if (order.notarizeTxHash) { %>
                    <div class="muted">Notarize tx: <span class="mono"><%= order.notarizeTxHash %></span></div>
                  <% } %>
                  <button
                    class="btn btn-outline"
                    type="button"
                    data-receipt-verify
                    data-order-id="<%= order.escrowOrderId || '' %>"
                    data-receipt-type="delivery"
                    data-can-notarize="true"
                    data-seller-wallet="<%= order.sellerWallet || '' %>"
                    data-buyer-wallet="<%= order.buyerWallet || '' %>"
                    data-product-name="<%= order.productName || '' %>"
                    data-qty="<%= order.qty %>"
                    data-price-eth="<%= order.priceEth %>"
                    data-delivered-at="<%= order.deliveredAt ? new Date(order.deliveredAt).toLocaleString() : 'Pending' %>"
                    <%= order.orderHash && order.escrowOrderId ? "" : "disabled" %>
                  >
                    Verify receipt
                  </button>
                  <span class="muted status-text" data-verify-status style="margin-left:6px;"></span>
                  <span class="muted status-text" data-verify-timestamp style="margin-left:6px;"></span>
                </div>
                <% if (order.status === "Delivered") { %>
                  <div style="margin-top:10px;">
                    <strong>Upload delivery proof</strong>
                    <p class="muted" style="margin:6px 0 0;">Optional: add delivery proof for your records.</p>
                    <% if (order.deliveryProofFile) { %>
                      <a class="btn btn-ghost" style="margin-top:8px;" href="<%= order.deliveryProofFile %>" target="_blank" rel="noopener">
                        View delivery proof
                      </a>
                    <% } else { %>
                      <form
                        class="stack"
                        action="/buyer/orders/<%= order.id %>/proof-delivered"
                        method="POST"
                        enctype="multipart/form-data"
                        data-proof-upload
                      >
                        <input type="hidden" name="buyerWallet" value="<%= order.buyerWallet || '' %>" />
                        <input type="file" name="proofFile" accept="image/*,application/pdf" required data-proof-input />
                        <div class="muted" style="font-size:12px;">PNG/JPG/PDF up to 8MB.</div>
                        <div class="proof-preview">
                          <img
                            class="thumb"
                            data-proof-preview
                            alt="Delivery proof preview"
                            style="width:56px; height:56px; border-radius:10px; border:1px solid #e2e8f0; object-fit:cover; display:none;"
                          />
                          <span class="muted" data-proof-meta></span>
                        </div>
                        <button class="btn btn-ghost" type="submit" disabled>Upload delivery proof</button>
                        <span class="muted status-text" data-tx-status>Verify the receipt to enable upload.</span>
                      </form>
                    <% } %>
                  </div>
                <% } %>
              </div>
            <% } %>
            <% if (order.status === "Shipped" || order.status === "Delivered") { %>
              <form action="/buyer/orders/<%= order.id %>/deliver" method="POST" data-escrow-action="deliver" data-escrow-order-id="<%= order.escrowOrderId || '' %>" data-expected-wallet="<%= order.buyerWallet || '' %>">
                <button
                  class="btn btn-alt"
                  type="submit"
                  <%= order.status !== "Shipped" ? "disabled" : "" %>
                  style="<%= order.status !== 'Shipped' ? 'background:#e2e8f0; border-color:#e2e8f0; color:#475569;' : '' %><%= order.status === 'Delivered' ? 'background:#16a34a; border-color:#16a34a; color:#f8fafc;' : '' %>"
                >
                  <%= order.status === "Delivered" ? "Delivery confirmed" : "Confirm delivery" %>
                </button>
                <span class="muted status-text" data-tx-status style="margin-left:8px;"></span>
              </form>
            <% } %>
            <% if (order.status === "Delivered" && !order.rated && !order.reviewSkipped) { %>
              <% if (!order.reviewOpen) { %>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <form action="/buyer/orders/<%= order.id %>/review/start" method="POST">
                    <button class="btn btn-ghost" type="submit">Leave a review</button>
                  </form>
                  <form action="/buyer/orders/<%= order.id %>/review/skip" method="POST">
                    <button class="btn btn-outline" type="submit">Skip review</button>
                  </form>
                </div>
              <% } else { %>
                <form class="stack" action="/buyer/orders/<%= order.id %>/rate" method="POST" data-escrow-action="rate" data-escrow-order-id="<%= order.escrowOrderId || '' %>" data-expected-wallet="<%= order.buyerWallet || '' %>">
                  <label>Stars (1-5)</label>
                  <div class="star-rating">
                    <input type="radio" id="order-<%= order.id %>-star-5" name="stars" value="5" checked required />
                    <label for="order-<%= order.id %>-star-5" title="5 stars">★</label>
                    <input type="radio" id="order-<%= order.id %>-star-4" name="stars" value="4" />
                    <label for="order-<%= order.id %>-star-4" title="4 stars">★</label>
                    <input type="radio" id="order-<%= order.id %>-star-3" name="stars" value="3" />
                    <label for="order-<%= order.id %>-star-3" title="3 stars">★</label>
                    <input type="radio" id="order-<%= order.id %>-star-2" name="stars" value="2" />
                    <label for="order-<%= order.id %>-star-2" title="2 stars">★</label>
                    <input type="radio" id="order-<%= order.id %>-star-1" name="stars" value="1" />
                    <label for="order-<%= order.id %>-star-1" title="1 star">★</label>
                  </div>
                  <label>Comment</label>
                  <textarea name="comment" rows="3" required></textarea>
                  <button class="btn btn-ghost" type="submit">Submit rating</button>
                  <span class="muted status-text" data-tx-status></span>
                </form>
              <% } %>
            <% } else if (order.rated) { %>
              <span class="muted">Rating submitted.</span>
            <% } else if (order.reviewSkipped) { %>
              <span class="muted">Review skipped.</span>
            <% } %>
          </div>
        </div>
      </div>
    <% }) %>
  </div>
</section>

<%- include("partials/footer") %>
